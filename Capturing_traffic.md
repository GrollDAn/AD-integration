## Захват трафика при вводе компьютера в домен

 Захват трафика во время ввода компьютера в домен является важной процедурой для последующего анализа сетевых взаимодействий. Это позволяет:
- Детально изучить процесс присоединения устройства к домену.
- Определить выполняемые условия и шаги.
- Проанализировать используемые сетевые протоколы (например, Kerberos, LDAP, SMB).
- Исследовать запросы и ответы между рабочей станцией и контроллером домена.
- Полученные данные позволяют выявить возможные проблемы или ошибки конфигурации в процессе ввода в домен.
---

 ### Подготовка машин для захвата трафика

Процесс захвата трафика может выполняться, как на стороне контроллера домена, так и на клиентской машине, которая вводится в домен. Методика одинакова для различных операционных систем (например, Windows и Linux).

Для выполнения захвата трафика необходимо:
1. **Контроллер домена** — сервер, на котором работает Active Directory.
2. **Рабочая станция** — машина, которая будет вводиться в домен.
3. **Программное обеспечение для захвата трафика** —  Wireshark.
___

### Процесс захвата трафика 

1. **Установка программы Wireshark.**  
   На ALT Linux установите программу Wireshark, используя следующую команду:  
   ```
     # apt-get install wireshark
   ``` 
 

2. **Запуск Wireshark.**  
    Откройте Wireshark на рабочей станции. Альтернативно, можно выполнить захват трафика на контроллере домена, в зависимости от задач. 

3. **Настройка фильтров для захвата трафика.**  
   Для анализа, исключительно взаимодействия между контроллером домена и рабочей станцией, настройте фильтр в Wireshark: 
   ```
   (ip.src == 192.168.1.1 && ip.dst == 192.168.1.2) || (ip.src == 192.168.1.2 && ip.dst == 192.168.1.1)
   ```
   Где:
*    192.168.1.1 — IP-адрес контроллера домена.
*    192.168.1.2 — IP-адрес рабочей станции.

4. **Выбор сетевого интерфейса.**  
   В Wireshark выберите сетевой интерфейс, который будет использоваться для захвата трафика. На рабочей станции с ALT Linux это, например, интерфейс **eth0**. Для выбора интерфейса выполните двойной щелчок по нему. 

5. **Ввод рабочей станции в домен.**  
   Выполните ввод рабочей станции в домен, используя учетные данные с правами администратора домена или учетной записи, имеющей соответствующие права. 

6. **Завершение захвата трафика.**  
   После успешного ввода рабочей станции в домен, остановите процесс захвата трафика в Wireshark, нажав на кнопку  **Stop** (красный квадрат) в верхней панели управления.  

7. **Сохранение захваченных данных.**  
  Сохраните файл с захваченным трафиком для последующего анализа. Используйте формат **pcapng**, который предлагается по умолчанию: 
  * В меню Wireshark выберите **File → Save As**.
  * Укажите имя файла и директорию для сохранения.
  * Убедитесь, что формат файла установлен как **pcapng**.

---

### Создание keytab файла

Для дальнейшего анализа захваченного трафика и расшифровки аутентификационных пакетов (например, Kerberos), необходимо создать **keytab файл**. Этот файл содержит криптографические ключи, которые используются для аутентификации пользователей и машин в домене. **Keytab** файл позволит расшифровать пакеты, связанные с процессом ввода машины в домен, и анализировать их.

___

### Создание keytab файла на машине ALT Linux, введённой в домен

После того как машина ALT Linux была успешно введена в домен Samba AD или MS AD, создание keytab файла удобно выполнить непосредственно на этой машине. Следующие шаги помогут вам создать и проверить содержимое keytab файла:

**1. Перезагрузка машины и вход с правами доменного пользователя**   
После ввода машины в домен, необходимо перезагрузить рабочую станцию. Затем войдите в систему с учетной записью доменного пользователя. Это обеспечит доступ к ресурсам домена и позволит создать keytab файл, который будет содержать необходимые ключи для аутентификации в домене.

**2. Создание keytab файла с содержимым всех учетных записей в домене**  
Для создания keytab файла с содержимым всех учетных записей в домене выполните следующую команду:  
```bash
net rpc vampire keytab /home/DOMAIN.TEST/admin/combined.keytab -I 192.168.1.1 -U Admin@DOMAIN.TEST
```
_**Структура команды:**_  
```bash
net rpc vampire keytab /path/to/combined.keytab -I <ip_domain_controller> -U User@DOMAIN.EXAMPLE
```

_**Описание параметров:**_  
- /home/DOMAIN.TEST/admin/combined.keytab — путь, где будет сохранен созданный keytab файл.  
-  192.168.1.1  — IP-адрес контроллера домена.  
-  Admin @DOMAIN.TEST — учетная запись администратора домена, которая будет использоваться для выполнения команды. Убедитесь, что у вас есть соответствующие права.

Команда **net rpc vampire keytab** создаст **keytab** файл, который будет содержать все ключи аутентификации для всех учетных записей, доступных в домене.


 **3. Установка пакета krb5-kadmin и утилиты ktutil.**   
Для работы с keytab файлами необходимо установить утилиту **ktutil**, которая является частью пакета **krb5-kadmin**. Для установки выполните команду:  
```bash
sudo apt-get install krb5-kadmin
```

**4. Проверка содержимого keytab файла.**  
После того как keytab файл был создан, вы можете проверить его содержимое с помощью утилиты `ktutil`. Для этого выполните следующие шаги:

- _**Запустите ktutil:**_
   ```bash
   ktutil
   ```

-  _**Загрузите созданный keytab файл:**_
   ```bash
   ktutil:  read_kt /home/DOMAIN.TEST/admin/combined.keytab
   ```

- _**Просмотрите содержимое файла:**_
   ```bash
   ktutil:  list
   ```

- _**Завершите работу с утилитой:**_
   ```bash
   ktutil:  quit
   ```

Это позволит вам убедиться, что ключи для нужных учетных записей корректно добавлены в файл.


**5. Просмотр информации о keytab файле и его шифрах.**  
Для просмотра содержимого keytab файла с дополнительной информацией о используемых шифрах, выполните команду:  
```
klist -kte /home/DOMAIN.TEST/admin/combined.keytab
```

Эта команда отобразит подробную информацию о содержимом файла, включая типы используемых шифров (например, AES256, RC4) и другие параметры.

 
После выполнения вышеуказанных шагов вы получите keytab файл, который можно использовать для аутентификации в процессе анализа Kerberos-трафика или для дальнейших операций с учетными записями в домене. Этот файл будет содержать ключи для аутентификации машин и пользователей, что позволит расшифровывать данные, связанные с их действиями в сети.

---

